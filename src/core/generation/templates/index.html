<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AGT Label Maker - Generate product labels">
  <title>AGT Label Maker</title>
  
  <!-- Stylesheets -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
  <style>
    /* Custom spinner overlay styling */
    #spinnerOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: none; /* Hidden by default */
      align-items: center;
      justify-content: center;
      z-index: 1070;
    }

    /* Lineage Context Menu Styles */
    .lineage-context-menu {
      position: fixed;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      padding: 4px 0;
      min-width: 150px;
    }

    .lineage-option {
      padding: 8px 16px;
      cursor: pointer;
      color: white;
      font-weight: bold;
      transition: opacity 0.2s;
    }

    .lineage-option:hover {
      opacity: 0.8;
    }

    /* Add these styles to the existing style block */
    .trippy-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .trippy-circle {
      position: absolute;
      border-radius: 50%;
      opacity: 0.3;
      filter: blur(40px);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .rotating-bg {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200vw;
      height: 200vh;
      background: repeating-conic-gradient(
        from 0deg,
        #ff00ff 0deg 60deg,
        #00ffff 60deg 120deg,
        #ff00ff 120deg 180deg,
        #00ffff 180deg 240deg,
        #ff00ff 240deg 300deg,
        #00ffff 300deg 360deg
      );
      opacity: 0.1;
      animation: rotate 20s linear infinite;
      pointer-events: none;
      z-index: -2;
    }

    .mega-generate-btn {
      font-size: 2.2rem !important;
      font-weight: 900 !important;
      padding: 1.2rem 0 !important;
      background: linear-gradient(90deg, #007bff 0%, #00c6ff 100%) !important;
      color: #fff !important;
      border: none !important;
      border-radius: 1.5rem !important;
      box-shadow: 0 0 32px 0 rgba(0,123,255,0.45), 0 8px 32px 0 rgba(0,0,0,0.18) !important;
      text-shadow: 0 2px 8px rgba(0,0,0,0.18);
      letter-spacing: 1.5px;
      transition: transform 0.15s, box-shadow 0.15s;
      outline: none !important;
      margin: 0.5rem 0 1.5rem 0;
      position: relative;
      z-index: 2;
    }
    .mega-generate-btn:hover, .mega-generate-btn:focus {
      background: linear-gradient(90deg, #0056b3 0%, #00aaff 100%) !important;
      box-shadow: 0 0 48px 0 #007bff99, 0 12px 48px 0 rgba(0,0,0,0.22) !important;
      transform: scale(1.03);
    }
  </style>
</head>
<body class="bg-light">
  <!-- Add trippy background elements -->
  <div class="rotating-bg"></div>
  <div class="trippy-bg">
    <div class="trippy-circle" style="top: 20%; left: 20%; width: 300px; height: 300px; background: #ff00ff;"></div>
    <div class="trippy-circle" style="top: 60%; left: 70%; width: 400px; height: 400px; background: #00ffff;"></div>
    <div class="trippy-circle" style="top: 40%; left: 40%; width: 200px; height: 200px; background: #ff00ff;"></div>
  </div>

  <!-- Add spinner overlay -->
  <div class="spinner-overlay">
      <div class="spinner"></div>
  </div>

  <!-- Title and Subtitle at the top -->
  <div class="container-fluid py-4" style="z-index:1; position:relative;">
    <div class="row mb-4 fade-in">
      <div class="col">
        <div class="header-container">
          <div class="header-align-centerframe">
            <h1 class="vibrant-title mb-2" data-text="AGT Designer">
              AGT Designer
            </h1>
            <p class="vibrant-subtitle">
              <span class="larger-letter">A</span>uto-<span class="larger-letter">G</span>enerating <span class="larger-letter">T</span>ag Software
            </p>
            <p class="copyright-text">
              ©2025 Created by Adam Cordova for A Greener Today
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid mt-3">
    <!-- Upload and JSON Row -->
    <div class="row mb-3 justify-content-center">
      <div class="col-md-6 mb-2 d-flex justify-content-center">
        <div class="card shadow-sm card-width">
          <div class="upload-bar-container d-flex align-items-center p-3">
            <button class="btn btn-primary me-2" id="uploadButton" title="Click to upload file">Upload</button>
            <span id="currentFile">No file selected</span>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-2 d-flex justify-content-center">
        <div class="card shadow-sm card-width">
          <div class="json-bar-container d-flex align-items-center p-3">
            <button class="btn btn-secondary me-2" id="jsonButton">JSON</button>
            <input type="text" class="form-control" id="jsonUrlInput" placeholder="Enter JSON URL here...">
          </div>
        </div>
      </div>
    </div>

    <!-- Control Panel Row -->
    <div class="row mb-3">
      <div class="col">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="row g-2 align-items-center">
              <div class="col-auto">
                <label for="templateSelect" class="form-label mb-0">Template</label>
                <select id="templateSelect" class="form-select">
                  <option value="horizontal">Horizontal</option>
                  <option value="vertical">Vertical</option>
                  <option value="mini">Mini</option>
                  <option value="inventory">Inventory</option>
                </select>
              </div>
              
              <div class="col-auto">
                <label for="scaleInput" class="form-label mb-0">Scale</label>
                <input type="number" id="scaleInput" class="form-control" value="1.0" min="0.5" max="2.0" step="0.1" title="Adjust scale factor">
              </div>
              
              <div class="col-auto">
                <button id="generateBtn" class="btn btn-primary w-100 mega-generate-btn" title="Generate labels based on selected tags">Generate Tags</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tag Selection Area -->
    <div class="row main-content-row">
      <div class="col-md-6 mb-0">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center py-1">
            <span>Available Tags (Filter using the dropdowns to the left)</span>
            <span id="availableTagsCount" class="badge bg-secondary">(0)</span>
          </div>
          <!-- Filter bar directly after card header - now sticky -->
          <div class="sticky-filter-bar">
            <div class="row g-4 mb-4 px-4 pt-4 pb-3">
              <div class="col filter-column">
                <label for="vendorFilter" class="form-label small mb-3">Vendor</label>
                <select id="vendorFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by vendor">
                  <option value="All">All Vendors</option>
                </select>
              </div>
              <div class="col filter-column">
                <label for="brandFilter" class="form-label small mb-3">Brand</label>
                <select id="brandFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by brand">
                  <option value="All">All Brands</option>
                </select>
              </div>
              <div class="col filter-column">
                <label for="productTypeFilter" class="form-label small mb-3">Product Type</label>
                <select id="productTypeFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by product type">
                  <option value="All">All Product Types</option>
                </select>
              </div>
              <div class="col filter-column">
                <label for="weightFilter" class="form-label small mb-3">Weight</label>
                <select id="weightFilter" class="form-select form-select-sm compact-filter" aria-label="Filter by weight">
                  <option value="All">All Weights</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="controls-container">
                <div class="available-controls">
                    <input type="checkbox" id="selectAllAvailable">
                    <label for="selectAllAvailable">Select All Available</label>
                </div>
            </div>
            <div id="availableTags" class="tag-list"></div>
          </div>
        </div>
      </div>

      <div class="col-md-auto d-flex align-items-center justify-content-center mb-0">
        <div class="d-grid gap-0">
          <button id="btnMoveToSelected" class="btn btn-outline-primary btn-sm" title="Move selected tags to right">→</button>
          <button id="btnMoveToAvailable" class="btn btn-outline-primary btn-sm" title="Move selected tags to left">←</button>
        </div>
      </div>

      <div class="col-md-6 mb-0">
        <div class="card shadow-sm">
          <div class="card-header d-flex justify-content-between align-items-center py-1">
            <span>Selected Tags (Tags chosen in the left column will be staged for generation)</span>
            <span id="selectedTagsCount" class="badge bg-secondary">(0)</span>
          </div>
          <div class="card-body p-0">
            <div class="controls-container">
                <div class="selected-controls">
                    <input type="checkbox" id="selectAllSelected">
                    <label for="selectAllSelected">Select All Selected</label>
                </div>
            </div>
            <div id="selectedTags" class="tag-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast for error messages -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="errorToast" class="toast align-items-center text-white bg-danger border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastMessage"></div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner Overlay -->
  <div id="spinnerOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Hidden input to store current file path -->
  <input type="hidden" id="current-filepath" value="{{ initial_data.filepath if initial_data else '' }}">

  <!-- Data attribute for initial data -->
  <div id="initialData" data-filepath="{{ initial_data.filepath if initial_data else '' }}"></div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Main Application Script - Move this BEFORE initialization -->
  <script src="{{ url_for('static', filename='js/main.js') }}"></script>
  
  <!-- Initialize App Data and Error Handling -->
  <script>
    // Safely parse initial data
    const getInitialData = () => {
      try {
        const initialDataStr = document.getElementById('initialData').getAttribute('data-initial');
        const data = initialDataStr ? JSON.parse(initialDataStr) : null;
        return data;
      } catch (error) {
        console.error('Error parsing initial data:', error);
        return null;
      }
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
        const initialData = getInitialData();
        console.log('Loading initial data:', initialData);
        
        if (initialData) {
            // Initialize filters
            if (initialData.filters) {
                try {
                    if (typeof window.updateFilters === 'function') {
                        window.updateFilters(initialData.filters);
                    } else {
                        console.error('updateFilters function not found');
                    }
                } catch (error) {
                    console.error('Error updating filters:', error);
                    showError('Error loading filters');
                }
            }
            
            // Initialize available tags
            if (initialData.available_tags) {
                try {
                    if (typeof window.updateAvailableTags === 'function') {
                        window.updateAvailableTags(initialData.available_tags);
                    } else {
                        console.error('updateAvailableTags function not found');
                    }
                } catch (error) {
                    console.error('Error updating tags:', error);
                    showError('Error loading tags');
                }
            }
            
            // Update current file display
            const currentFileElement = document.getElementById('currentFile');
            if (currentFileElement && initialData.filename) {
                currentFileElement.textContent = initialData.filename;
            }
        } else {
            console.log('No initial data available');
        }
    });
  </script>
</body>
</html>